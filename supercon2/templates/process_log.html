<!DOCTYPE XHTML>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <title>SuperCon2 | Processing log</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.5.95/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.6.3/dist/vuetify.min.css" rel="stylesheet">    <link rel="icon" type="image/x-icon" href={{ url_for('static', filename='resources/img/favicon.ico' ) }} />
    <link rel="shortcut icon" type="image/x-icon" href={{ url_for('static', filename='resources/img/favicon.ico' ) }} />
    <link rel="stylesheet" href={{ url_for('static', filename='resources/css/style-superconductors.css') }}/>
    <style>
        .bg-floralwhite {
            background: floralwhite
        }
        .bg-white {
            background: white
        }
    </style>
</head>

<body>
    <v-app id="app">
        <v-container fluid>
            <v-row class="justify-space-between ma-0">
                <v-card flat>
                    <h2>SuperCon<sup>2</sup> | Processing log</h2>
                </v-card>
            </v-row>
            <v-data-table v-model="selectedItems" :headers="showHeaders" :items="items" :dense="true" single-select
                loading-text="loading ..." :loading="isLoading" :multi-sort="true" class="elevation-1" :item-class="getItemClass"
                @current-items="hasChangedCurrentItems" :page.sync="page" :footer-props="{'items-per-page-options':[20, 50, 100]}"
                :sort-by.sync="sortBy" :sort-desc.sync="sortDesc" @page-count="hasChangedPageCount" @click:row="clickRow">
                <template v-slot:body.prepend>
                    <tr>
                        <td v-for="header in showHeaders" :key="header.value">
                            <v-radio-group v-model="header.filterKeyword" v-if="header.value === 'type'" dense
                                hide-details>
                                <v-row class="pb-1" v-for="radio in headerObject.type.radioGroup">
                                    <v-radio dense :value="radio.value" class="ma-0">
                                    </v-radio>
                                    <v-icon small :title="radio.value" @click="header.filterKeyword = radio.value">
                                        [[ radio.icon ]]
                                    </v-icon>
                                </v-row>
                            </v-radio-group>
                            <v-radio-group v-model="header.filterKeyword" v-else-if="header.value === 'status'" dense hide-details>
                                <v-select :items="headerObject.status.selectItems" v-model="header.filterKeyword"/>
                            </v-radio-group>
                            <template v-else-if="header.value === 'service'" dense hide-details>
                                <v-select :items="headerObject.service.selectItems" v-model="header.filterKeyword"/>
                            </template>
                            <template v-else>
                                <v-text-field v-model="header.filterKeyword" type="text" placeholder="keyword" hide-details clearable/>
                            </template>
                        </td>
                    </tr>
                </template>
                <template v-slot:item.hash="{ item }">
                    <v-row>
                        <a :href="base_url + 'pdf/' + item.hash"
                            target="_blank"
                            :style="{'text-decoration': 'none'}"
                            class="ma-1" title="View document">
                            [[ item.hash ]]
                        </a>
                        <v-icon
                            @click="headerObject.hash.filterKeyword = item.hash"
                            :title="'Filter by this documenft ID: ' + item.hash">
                            mdi-filter
                        </v-icon>
                    </v-row>
                </template>
                <template v-slot:item.timestamp="{ item }">
                    <v-row>[[ new Date(item.timestamp + "Z").toString() ]]</v-row>
{#                    <v-row>[[ new Date(item.timestamp + "Z").toString().split("GMT", 1)[0] ]]</v-row>#}
                </template>
            </v-data-table>
            <p><span style="color:#848484;">&copy; Contributors, 2022 |</span> <span id="version" style="color:#848484;" v-html="version"></span></p>
        </v-container>
    </v-app>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.3/dist/vuetify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@0.26.1/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjs@11.3.1/lib/browser/math.min.js"></script>
    <script>
        let itemClassStore = {
            class: 'bg-white',
            hashes: [],
        }
        const app = new Vue({
            delimiters: ['[[', ']]'],
            el: '#app',
            vuetify: new Vuetify(),
            data() {
                return {
                    base_url: '{{ base_url }}',
                    itemDialog: {
                        mode: '', // 'edit', 'new', 'remove'
                        shouldShow: false,
                    },
                    shouldShowShortcutKeysDialog: false,
                    isLoading: true,
                    version: 'unknown version',
                    editedItem: {},
                    page: 1,
                    pageCount: 0,
                    itemsPerPage: 10,
                    itemsPerPageOptions: [25, 50, 100],
                    sortBy: ['timestamp', 'hash'],
                    sortDesc: true,
                    selectedItems: [],
                    filteredItems: [],
                    selectedHeaders: [],
                    headers: [
                        { text: 'Record id', value: 'id', hidden: true, filter: this.idFilter, filterKeyword: '', shouldHideEmpty: false, width: 120, },
                        { text: 'Update count', value: 'update_count', hidden: true, shouldHideEmpty: false, width: 10, },
                        { text: 'Message', value: 'message', hidden: false, filter: this.messageFilter, filterKeyword: '', shouldHideEmpty: false },
                        { text: 'Service', value: 'service', hidden: false, filter: this.serviceFilter, filterKeyword: 'all', shouldHideEmpty: false,
                            selectItems: [
                                'all', 'extraction', 'table_compute'
                            ]
                        },
                        { text: 'Path', value: 'path', hidden: false, filter: this.pathFilter, filterKeyword: '', shouldHideEmpty: false },
                        { text: 'Document', value: 'hash', hidden: false, filter: this.hashFilter, filterKeyword: "{{hash}}", width: 120, shouldHideEmpty: false },
                        { text: 'Timestamp', value: 'timestamp', hidden: false, filter: this.timestampFilter, filterKeyword: '', shouldHideEmpty: false },
                        {
                            text: 'Status', value: 'status', sortable: false, hidden: false, filter: this.statusFilter, filterKeyword: 'all', width: 80,
                            selectItems: [
                                'all', 'any error'
                            ]
                        },
                    ],
                    items: [],
                    rules: {
                        required: value => !!value || 'Required.',
                    },
                }
            },
            computed: {
                showHeaders() {
                    return this.headers.filter(s => this.selectedHeaders.includes(s));
                },
                selectedItem() {
                    return this.selectedItems[0]
                },
                pageIsFirst() {
                    return this.page === 1
                },
                pageIsLast() {
                    return this.page === this.pageCount
                },
                rowNumber() {
                    const ids = this.filteredItems.map(item => item.id)
                    return this.selectedItems.length === 1 ? ids.indexOf(this.selectedItem.id) : undefined
                },
                lastFilteredItem() {
                    return this.filteredItems[this.filteredItems.length - 1]
                },
                firstFilteredItem() {
                    return this.filteredItems[0]
                },
                saveIsValidated() {
                    return this.editedItem.doi && this.editedItem.hash && this.editedItem.error_type
                },
                headerObject() {
                    return Object.fromEntries(new Map(
                        this.headers.map(header => {
                            return [header.value, header]
                        })
                    ))
                },
            },
            mounted() {
                this.loadItems()
            },
            beforeDestroy() {
            },
            async beforeMount() {
                let url = '{{ url_for("supercon.get_version") }}'
                try {
                    const result = await axios.get(url, {})
                    this.version = result.data['version']
                } catch (e) {
                    console.error(e)
                    window.alert(JSON.stringify(e.response.data))
                } finally {
                }
            },
            methods: {
                copyTextToClipboard(text) {
                    navigator.clipboard.writeText(text)
                },
                showWholeSentence(item) {
                    item.sentenceIsExpanded = true
                    this.headerObject.sentence.width = 400
                },
                loadItems() {
                    this.isLoading = true
                    const url =
                        '{{ url_for("supercon.get_process_records") }}'
                    axios.get(url).then((data) => {
                        this.items = data.data
                        return
                    }).finally(() => {
                        this.isLoading = false
                    })
                },
                hasChangedPageCount(pageCount) {
                    this.pageCount = pageCount
                },
                clickRow(item, event) {
                    event.select(!event.isSelected)
                },
                hasChangedCurrentItems(items) {
                    this.filteredItems = items
                },
                nameFilter(_, __, item) {
                    return this.keywordFilter(this.headerObject.name, item.name)
                },
                pathFilter(_, __, item) {
                    return this.keywordFilter(this.headerObject.path, item.path)
                },
                hashFilter(_, __, item) {
                    return this.keywordFilter(this.headerObject.hash, item.hash)
                },
                idFilter(_, __, item) {
                    return this.keywordFilter(this.headerObject.id, item.id)
                },
                timestampFilter(_, __, item) {
                    return this.keywordFilter(this.headerObject.timestamp, item.timestamp)
                },
                messageFilter(_, __, item) {
                    return this.keywordFilter(this.headerObject.message, item.message)
                },
                keywordFilter(header, target) {
                    const keyword = this.sanitizeString(header.filterKeyword)
                    target = this.sanitizeString(target);
                    const shouldHideEmpty = header.shouldHideEmpty
                    if (!keyword && !shouldHideEmpty) {
                        return true
                    }
                    if (!target) {
                        return false
                    }
                    const target_lower = target.toLowerCase()
                    const keyword_lower = keyword.toLowerCase()
                    return target_lower.indexOf(keyword_lower) > -1
                },
                sanitizeString(target) {
                    if (typeof target === 'string') {
                        return target.trim()
                    } else {
                        return ''
                    }
                },
                serviceFilter(value, search, item) {
                    const keyword = this.headerObject.service.filterKeyword
                    switch (keyword) {
                        case 'all':
                            return true
                        default:
                            return item.service === keyword
                    }
                },
                statusFilter(value, search, item) {
                    const keyword = this.headerObject.status.filterKeyword
                    switch (keyword) {
                        case 'all':
                            return true
                        case 'any error':
                            return item.status !== '200'
                        default:
                            return item.status === keyword
                    }
                },
                flagIsNotWritable(record) {
                    return record.type === 'manual' && record.status === 'validated'
                },
                getItemClass(item) {
                    const store = itemClassStore
                    // to prevent reverse coloring when re-rendering
                    if (store.hashes.length > 1 && item.hash === store.hashes[0]) {
                        // initialize store
                        store.hashes = []
                        store.class = "bg-white"
                    }
                    if (item.hash === store.hashes[store.hashes.length-1]) {
                        return store.class
                    } else {
                        store.hashes.push(item.hash)
                        store.class = store.class === 'bg-floralwhite' ? 'bg-white' : 'bg-floralwhite'
                        return store.class
                    }
                }
            },
            created() {
                this.selectedHeaders = this.headers.filter(h => !h.hidden)
            },
        })
    </script>

</body>

</html>
